<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Status Change: Now Using Event Sourcing</title>

		<meta name="description"
			  content="Being flexible to changes in business process makes our jobs easier, and it helps our applications adapt to those changes with minimal code changes. One of the biggest adaptions in our applications has been the addition of Events to make a note of an Event in the system. With these Events, we can affect change immediately, or even later. This is most helpful in our reporting interfaces. We can build, change, and throw away our reports very easily. This is much easier than our older reports being generated by large SQL queries.">
		<meta name="author" content="Emily Stamey">

        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

        <meta name="viewport"
              content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/white.css">
        <link rel="stylesheet" href="css/my-style.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="./node_modules/highlight.js/styles/zenburn.css">

        <link rel="icon" type="image/x-icon" href="favicon.ico" />

        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->

		<link rel="stylesheet" href="plugin/accessibility/helper.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
            <div class='footer'>
                @elstamey      <a href="https://joind.in/talk/c8690">https://joind.in/talk/c8690</a>
            </div>
			<div class="slides">
                <section>
                    <myRowBox>
                        <article>
                            <h3>Status Change: Now Using Event Sourcing</h3>
                            <p>by Emily Stamey</p>
                            <p><a href="https://joind.in/talk/c8690">https://joind.in/talk/c8690</a></p>
                        </article>
                        <article>
                            <img src="img/status_change/events.jpg"
                        </article>
                    </myRowBox>
                    <aside class="notes">
                    </aside>
                </section>
                <section>
                    <myColBox>
                        <article>
                            <h2>Hi, I'm Emily!</h2>
                            <p>I work at NC State</p>
                            <p>Our applications support the College of Engineering, mostly outside of the classroom</p>
                            <p>We maintain 70 legacy applications</p>
                        </article>
                        <article>
                            <myrowBox>
                                <article>
                                    <img src="img/me/developer.png" alt="developer">
                                </article>
                                <article>
                                    <img src="img/me/ncsu_block_s.png" alt="NC State University logo">
                                </article>
                            </myrowBox>
                        </article>
                    </myColBox>
                    <aside class="notes">
                        <p>We are going to talk about Event Sourcing, but we will begin in a sort of roundabout way because
                            at State we have been adding Event Sourcing to many of our legacy projects.  We have one project
                            that we are rewriting, and it's a good case study for an older approach with status flags and we are rewriting it to use
                            event sourcing.</p>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>What we&#39;ll cover:</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <ul>
                                <li>Processes from paper to web forms</li>
                                <li>What is Event Sourcing?</li>
                                <li>Introducing what this code looks like (LIGHT)</li>
                                <li>Advantages and Disadvantages</li>
                            </ul>
						</article>
                    </myColBox>
                    <aside class="notes">
                        <li>We will talk about these web processes going from paper forms to web forms.</li>
                        <li>The definitions and terminology around Event Sourcing</li>
                        <li>We'll talk about what the PHP code generally looks like in this event sourced application</li>
                        <li>Finally, we'll look at pros and cons.  It's a REAL mental shift coming from a legacy application to Event Sourcing</li>

                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Sign the waiver</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>I, __(state your name)__, will not blame Emily if Event Sourcing makes my head explode. I promise I will not leave a bad review. And I promise to be kind to myself as I learn new things. </article>
                        <article><img src="img/status_change/head_explode.gif" class="fragment"></article>
                    </myColBox>
                    <footer>
                        <p><i class="fragment">Emily will not be held responsible if your head explodes</i></p>
                    </footer>
                </section>
                <section>
                    <myTitleBox>
                        <h1>Brace Yourself!</h1>
                    </myTitleBox>
                    <myRowBox>
                        <article>
                            <img src="img/status_change/sea_kayak_waves_lee_ciaran.jpg">
                            <h5 class="attrib" style="position: relative; top: 500px; align: bottom;left: -100px;">&copy; photo by <a
                                    href="https://www.flickr.com/photos/lee_ciaran/">Ciaran Lee</a></h5>
                        </article>
                    </myRowBox>
                    <aside class="notes">
                        <li>So be patient with yourself</li>
                        <li>If you've ever done this, you know it's tough.  The strategy is to point into the waves and paddle HARD</li>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h1>Relax, Enjoy the Ride!</h1>
                    </myTitleBox>
                    <myRowBox>
                        <article>
                            <img src="img/status_change/sea_kayak_crash_lisakayaks.jpg">
                            <h5 class="attrib" style="position: relative; top: 500px; align: bottom;left: -100px;">&copy; photo by <a
                                    href="https://www.flickr.com/photos/lisakayaks/">Lisa Ouellette</a></h5>
                        </article>
                    </myRowBox>
                    <aside class="notes">
                        <li>If you try to change direction, you often tip over like this.</li>
                        <li>This is my way of asking that you try to follow along with me.</li>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Forms</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <p>A lot of our systems were built to replace paper processes</p>
                            <p>They often closely map to this physical form.</p>

                        </article>
                        <article>
                            <img src="img/status_change/tax_form_aidanmorgan.jpg" alt="Paper form">
                            <h5 class="attrib" style="">&copy; photo by <a
                                    href="https://www.flickr.com/photos/aidanmorgan/">Aidan Morgan</a></h5>
                        </article>
                    </myColBox>
                    <aside class="notes">
                        <li>What I see a lot at the University is that many of our applications began with a need to
                            collect data from paper forms that students were filling out.</li>
                        <li>As the administration became comfortable with computers, more of the process went into our applications</li>
                        <li>Often this meant increased complexity in the tools</li>
                    </aside>
                </section>
                <section>
                    <myColBox>
                        <article>
                            <img src="img/status_change/FormProcess.svg" alt="FormProcess"></p>
                        </article>
                    </myColBox>
                    <aside class="notes">
                        <li>For this application, a student requests enrollment in a Distance Ed class</li>
                        <li> That request is either approved or rejected</li>
                        <li>The paper version of this process meant the Admin put the request form into an approve or reject pile</li>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Paper Forms handling state</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Copies_of_documents_at_European_Parliament_in_Strasbourg.jpg/1024px-Copies_of_documents_at_European_Parliament_in_Strasbourg.jpg" alt="Paper forms sorted for a process">
                        </article>
                        <article>
                            <p>Piles indicate status of the form</p>
                        </article>
                    </myColBox>
                    <aside class="notes">
                        <li>These piles indicated the status of the request</li>
                        <li>On the web, we created an admin panel with a drop-down to indicate status</li>
                        <li>Over time the concept of status grew in complexity</li>
                        <li>Processes that handled lots of forms could become much more complex, even in trying to organize them</li>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Paper Forms handling state</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                           <img src="img/status_change/collegerejection.jpg" alt="stamped application">
                        </article>
                        <article>
                            <p>Status doesn&#39;t really communicate why or what happened</p>
                        </article>
                    </myColBox>
                    <aside class="notes">
                        <li>You may have also seen a paper form with a stamp to indicate status.</li>
                        <li>But what if things change, and a rejection can be undone. Suppose it was rejected because tuition wasn't paid, the student paid</li>
                        <li>What if an request changes state multiple times through the process?  And each time the status overwrites itself?</li>
                        <!--<li>The history doesn't convey between piles. And sometimes our application doesn't retain that information either</li>-->
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Why are they in the current state?</h2>
                    </myTitleBox>
                    <myColBox>
                        <article></article>
                        <article>
                            <img src="img/status_change/history_book.png">
                        </article>
                    </myColBox>
                    <aside class="notes">
                        <li>The status tells where it is in the process, but it doesn't tell you what happened to get it there</li>
                        <p>Status names often carry assumed knowledge of the process without the system reflecting that meaning.</p>
                        <p>We are separated from the request&#39;s history.</p>
                        <p>Status labels & meaning can change without conveying process changes or changing things in the app.</p>
                    </aside>
                </section>
                <section>
                    <footer>
                        <img src="img/status_change/compensating_measures.jpg" alt="compensating_measures.jpg">
                    </footer>
                    <aside class="notes">
                        <p>Compensating measures this app made to attempt to preserve history</p>
                        <li>add columns to the table with form data</li>
                        <li>add a related table for notes</li>
                        <li>more statuses to include the many forks in the process (like what type of hold)</li>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>How workflows become complex</h2>
                    </myTitleBox>
                    <footer>
                       <img src="img/status_change/more_statuses.jpg" alt="more_statuses.jpg">
                    </footer>
                    <aside class="notes">
                        <p>Sometimes your workflow forks in multiple directions or involves long
                            lists in order to capture the complexity of the business process</p>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>This is what you may end up with</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <select name="newStatus">
                                <option value="RECEIVED">RECEIVED</option>
                                <option value="CANCELLED">CANCELLED</option>
                                <option value="COURSE CANCELLED">COURSE CANCELLED</option>
                                <option value="COURSE NOT APPROVED">COURSE NOT APPROVED</option>
                                <option value="CPC DENIED">CPC DENIED</option>
                                <option value="CPC NOT APPROVED">CPC NOT APPROVED</option>
                                <option value="CPC PENDING TRANSCRIPT">CPC PENDING TRANSCRIPT</option>
                                <option value="CPC PROCESSING">CPC PROCESSING<em></option>
                                <option value="DENIED">DENIED</option>
                                <option value="DROPPED AFTER CENSUS">DROPPED AFTER CENSUS</em></option>
                                <option value="DROPPED BEFORE CLASSES BEGUN">DROPPED BEFORE CLASSES BEGUN<em></option>
                                <option value="DROPPED BETWEEN BEGINNING OF CLASS AND CENSUS DATE">DROPPED BETWEEN BEGINNING OF CLASS AND CENSUS DATE</em></option>
                                <option value="DROPS/WITHDRAWALS AT SITES">DROPS/WITHDRAWALS AT SITES<em></option>
                                <option value="ECE ON CAMPUS STUDENTS">ECE ON CAMPUS STUDENTS</option>
                                <option value="ENROLLMENT CANCELLED">ENROLLMENT CANCELLED</option>
                                <option value="EOL APPROVED">EOL APPROVED</em></option>
                                <option value="EOL MISC">EOL MISC<em></option>
                                <option value="NEW STUDENT REGISTRATION">NEW STUDENT REGISTRATION</option>
                                <option value="PENDING ON CAMPUS REQUEST">PENDING ON CAMPUS REQUEST</option>
                                <option value="ON CAMPUS STUDENT NOT APPROVED">ON CAMPUS STUDENT NOT APPROVED</option>
                                <option value="PENDING CASHIER HOLD">PENDING CASHIER HOLD</option>
                                <option value="PENDING EOL APPROVAL">PENDING EOL APPROVAL</em></option>
                                <option value="PENDING INSTRUCTOR APPROVAL">PENDING INSTRUCTOR APPROVAL</option>
                                <option value="PENDING INTERNATIONAL STUDENT">PENDING INTERNATIONAL STUDENT</option>
                                <option value="PENDING NDS OPEN ENROLLMENT">PENDING NDS OPEN ENROLLMENT</option>
                                <option value="PENDING OIS VISA STUDENT">PENDING OIS VISA STUDENT</option>
                                <option value="PENDING PERMANENT RESIDENT">PENDING PERMANENT RESIDENT</option>
                                <option value="PENDING TERM ADVISEMENT HOLD">PENDING TERM ADVISEMENT HOLD</option>
                                <option value="PENDING TRANSCRIPT">PENDING TRANSCRIPT</option>
                                <option value="PENDING TUITION PREPAYMENT">PENDING TUITION PREPAYMENT</option>
                                <option value="PREAPPROVED RETURNING">PREAPPROVED RETURNING</option>
                                <option value="PROCESSING NDS">PROCESSING NDS<em></option>
                                <option value="PROCESSING SITE">PROCESSING SITE</em></option>
                                <option value="PROCESSING Z">PROCESSING Z<em></option>
                                <option value="PROJECT MESSAGE - MAE 586">PROJECT MESSAGE - MAE 586</option>
                                <option value="PROJECT MESSAGE - NE 693">PROJECT MESSAGE - NE 693</option>
                                <option value="REGISTERED">REGISTERED</option>
                                <option value="REGISTERED ASHEVILLE">REGISTERED ASHEVILLE</option>
                                <option value="REGISTERED HAVELOCK">REGISTERED HAVELOCK</option>
                                <option value="REGISTERED WILMINGTON">REGISTERED WILMINGTON</option>
                                <option value="SITE APPROVAL: ASHEVILLE">SITE APPROVAL: ASHEVILLE</em></option>
                                <option value="SITE APPROVAL: HAVELOCK">SITE APPROVAL: HAVELOCK<em></option>
                                <option value="SITE APPROVAL: WILMINGTON">SITE APPROVAL: WILMINGTON</em></option>
                                <option value="SITE NOT APPROVED">SITE NOT APPROVED</option>
                                <option value="SWAPPED OUT">SWAPPED OUT</option>
                                <option value="TRANSCRIPT APPROVED">TRANSCRIPT APPROVED<em></option>
                                <option value="WITHDRAWN">WITHDRAWN</em></option>
                            </select>
                        </article>
                    </myColBox>
                    <aside class="notes">
                        <p>I like to open this up for the full effect of how ridiculous it can become.  This group was
                            maintaining their own web app before we inherited it</p>
                        <p>You will notice these are actually subsets of the same status with explanation attached</p>
                        <li>Registered with a Site location</li>
                        <li>Pending with reasons attached</li>
                        <li>dropped with a time component of when it was dropped</li>
                        <li>Things like this make the drop-down complicated and go beyond the idea of what a status is</li>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h1>Something Happened</h1>
                    </myTitleBox>
                    <myColBox>
                        <article>

                        </article>
                    </myColBox>
                    <aside class="notes">
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h3>Something happened</h3>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <p>Status is a reflection of something that happened</p>
                            <p>There is ONE of each status + reasons/details  </p>
                            <p>Events can record what happened</p>
                        </article>
                        <article>
                            <img src="img/status_change/collegerejection.jpg" alt="stamped application">
                        </article>
                    </myColBox>
                    <aside class="notes">
                        <p>In a workflow, usually something happens and THEN your object&#39;s status is
                            updated to reflect that something happened.</p>
                        <p>There aren&#39;t 9 PENDING states.  There is ONE PENDING and 9 reasons for it to be PENDING </p>
                        <p>Events can record what ACTUALLY happened and the important details of that event.  It is actually your history!</p>
                        <p>Our code can then be written to describe what that event means with context.</p>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>The Request Doesn't Get Stuck</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <img src="img/status_change/speech-bubbles.png">
                        </article>
                        <!--<article>-->
                            <!--<p>The request doesn't get stuck.  One event can happen, and then another event can occur after it.</p>-->
                            <!--<p>A Hold can be lifted, and the request can continue through the process</p>-->
                            <!--<p>The request can move to a next state </p>-->
                            <!--<p>History is preserved</p>-->
                        <!--</article>-->
                    </myColBox>
                    <aside class="notes">
                        <p>The request doesn't get stuck.  One event can happen, and then another event can occur after it.</p>
                        <p>A Hold can be lifted, and the request can continue through the process</p>
                        <p>The request can move to a next state </p>
                        <p>History is preserved</p>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h1>Enter Event Sourcing</h1>
                    </myTitleBox>
                    <myColBox>
                        <article>

                        </article>
                    </myColBox>
                    <aside class="notes">
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Definition Event Sourcing</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <p>The fundamental idea of Event Sourcing is that of ensuring <strong>every change to the state</strong> of an application <strong>is captured in an event object</strong>, and that these event objects are themselves stored in the sequence they were applied for the same lifetime as the application state itself.</p>
                            <ul>
                                <li>Martin Fowler</li>
                            </ul>
                        </article>
                    </myColBox>
                    <aside class="notes">
                        <p>A lot of what we read about Event Sourcing comes from Martin Fowler.  But I like Greg Young's talks the best.  His examples are clear</p>
                        <p>The idea of Event Sourcing is that of ensuring <strong>every change to the state</strong> of an application <strong>is captured in an event object</strong>,</p>
                        <p>These event objects are then stored in the order they were applied for always and forever</p>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>What&#39;s important about Events</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <ul>
                                <li>Events</li>
                                <li>Details of the Event (attributes)</li>
                                <li>Order/Sequence</li>
                            </ul>
                        </article>
                    </myColBox>
                    <aside class="notes">
                        <p>We will collect the details of the event, its attributes</p>
                        <p>The timestamp is important in order to apply it in the correct order</p>
                        <p>If we were tracking transactions for a bank account, we would have events like Deposit Money
                            and Withdraw Money.  Those would have an amount and an account number.  And the order in
                            which they happened would be critical to having an accurate balance</p>
                        <p>We are capturing the crucial details with those events.  And our system will later apply them
                            using the rules of OUR process</p>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h3>Event Sourcing</h3>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <ol>
                                <li>Every happening is captured in an event object</li>
                                <li>Event objects are stored in the sequence they happened</li>
                                <li>That sequence determines the order they will be applied in your code</li>
                            </ol>
                        </article>
                    </myColBox>
                    <aside class="notes">
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h3>Rules for Events</h3>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <ul>
                                <li>Events are usually named as past-tense verbs</li>
                                <li>Have attributes that are values
                                    <ul>
                                        <li>never an aggregate root </li>
                                        <li>never a model/collection/object</li>
                                    </ul>
                                </li>
                            </ul>
                        </article>
                    </myColBox>
                    <aside class="notes">
                        <p>You will see event names like Enrollment Request Was Approved because validation was done prior to recording the event,
                        and these are KNOWN happenings in our system</p>
                        <p>This Event will have attributes, like the student id, the course id, who the approver was
                            because this is the important information</p>
                        <p>We wouldn't store the Enrollment Request Object because if we ever changed that object, we'd
                            have difficulty applying the event or reconstructing that object</p>
                        <p>Storing the VALUES on our Event gives us the flexibility for the system to change later
                            But that event never will</p>
                    </aside>
                </section>
                <section>
                    <myColBox>
                        <article>
                            <h2>The fact that an event happened <u>doesn&#39;t ever
                            change</u> even though the <u>behavior</u> around it may have</h2>
                        </article>
                    </myColBox>
                    <aside class="notes">
                        <p>Read it</p>
                        <p>So unlike statuses in our system which evolve over time and could change meaning, You will never change this event</p>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Why Events?</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <p><u>state transistions</u> are <u>important</u></p>
                            <p>We need an <u>audit log</u> and <u>proof</u> of state</p>
                            <p>This <u>history</u> is more important than the current state</p>
                            <p><u>Able to replay these events to rebuild state</u></p>
                        </article>
                    </myColBox>
                    <aside class="notes">
                        <li>The events that got us to this state are more important than the current status</li>
                        <li>We now have an audit log, and proof of how we got to this state</li>
                        <li>That history is more important that the current state BECAUSE</li>
                        <li>We are able to replay those events to prove the state</li>
                        <li>With our Scholarships Application, we collected the attributes that helped a student match for the scholarship to keep a record of why they were chosen </li>
                        <li>If we needed to see the budgets on any given day in the past, we could produce that information</li>
                        <li>And when they completely changed the format of budgets they wanted to review, we could easily rebuild that without affecting the amounts.</li>
                    </aside>
                </section>
                <!--<section>-->
                    <!--<myColBox>-->
                        <!--<article>-->
                           <!--<p><img src="img/status_change/why_events.jpg" alt="why_events.jpg"></p>-->
                        <!--</article>-->
                    <!--</myColBox>-->
                    <!--<aside class="notes">-->
                        <!--<li>The events that got us to this state are more important than the current status</li>-->
                        <!--<li>We now have an audit log, and proof of how we got to this state</li>-->
                        <!--<li>That history is more important that the current state BECAUSE</li>-->
                        <!--<li>We are able to replay those events to prove the state</li>-->
                        <!--<li>With our Scholarships Application, we collected the attributes that helped a student match for the scholarship to keep a record of why they were chosen </li>-->
                        <!--<li>If we needed to see the budgets on any given day in the past, we could produce that information</li>-->
                        <!--<li>And when they completely changed the format of budgets they wanted to review, we could easily rebuild that without affecting the amounts.</li>-->
                    <!--</aside>-->
                <!--</section>-->
                <section>
                    <footer>
                        <img src="img/status_change/dont_delete_events.jpg" alt="event_rules.jpg">
                    </footer>
                    <aside class="notes">
                        <p>Greg Young in a talk makes a point of how difficult it was to find a picture of an accountant erasing
                            because that's not something they do.  They make a correction undoing a mistake and then make the intended adjustment</p>
                        <p>So to fix one event, you may have two other events, but that event will (almost) never be deleted</p>
                        <p>You want to adjust your thinking in this way</p>
                    </aside>
                </section>
                <section>
                    <footer>
                       <p><img src="img/status_change/events-treated-differently.jpg"></p>
                    </footer>
                    <aside class="notes">
                        <p>In our system, we have an event with some meaning, and a listener that sees that event when it happens
                        <li>the apply method tells our system what should happen in this context and it produces this result</li>
                        <li>Maybe these are two different views in our system, that handle different behavior, those would coexist; like reports for two different types of users</li>
                    </aside>
                </section>
                <section>
                    <footer>
                        <p><img src="img/status_change/events-replaced.jpg"></p>
                    </footer>
                    <aside class="notes">
                        <li>but what if our understanding of the event changes.  We might rewrite that apply event method, which produces a different result</li>
                        <li>But it could also be that we rewrite what it means to apply that event and the new apply method stays, with the new report, and the old is deleted</li></p>
                    </aside>
                </section>
                <section>
                    <myColBox>
                        <article>
                            <p>Events don't change</p>
                            <p>The part of the
                                code that will change is most likely the result that follows that event.</p>
                            <p> The structure of the resulting data is more likely to change than the behavior</p>
                        </article>
                    </myColBox>
                    <aside class="notes">
                        <p>The event is less likely to change.  Things like Approve and Reject a
                            Request may later require additional attributes, but the part of the
                            process that will change is most likely the result that follows that event.</p>
                        <p> The structure of the resulting data is more likely to change than the behavior</p>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>The Code</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <p> There are many classes involved:</p>
                            <ul>
                                <li>Events</li>
                                <li>Domain Message</li>
                                <li>Classes with Listeners<ul>
                                    <li>Projections</li>
                                    <li>Read Models</li>
                                </ul>
                                </li>
                                <li>Commands &amp; Handlers (CQRS)</li>
                            </ul>
                        </article>
                    </myColBox>
                    <aside class="notes">
                        There are several patterns that we use here, and I'm going to try to describe how the pieces fit
                        together, but there are support classes that I won't be  able to go into in the time.  You can peruse the
                        code more closely on your own, but there is flexibility to how you built this in your application, so
                        take this approach with a grain of salt
                    </aside>
                </section>
                <section>
                    <myRowBox>
                        <article>
                            <img src="img/status_change/exercising_brain.jpg">
                        </article>
                    </myRowBox>
                    <aside class="notes">
                        <li>It's completely normal to feel like this when you're learning about Event Sourcing</li>
                        <li>It's a REAL mental shift coming from an older application to ES, so try to relax your brains a little</li>
                        <li>Try to follow the way I'm describing how it can be used moreso than the code examples.  Those will be available for you to look at.</li>
                        <li>And unfortunately I don't have all of this tied together yet, as with MANY of the online Event Sourcing examples</li>
                        <li>But you will gain a better understanding of how this can be useful, and some resources to get you started</li>
                        <li>Be patient with yourself and know that you may do more reading before this clicks</li>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Enrollment Request Rejected (Event)</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <ul>
                                <li>request id</li>
                                <li>student id</li>
                                <li>course offering id</li>
                            </ul>
                        </article>
                    </myColBox>
                    <aside class="notes">
                        <li>We will look at the Enrollment Request Rejected event for parts of this process</li>
                        <li>We have a couple of other sections we may jump to to explain the parts, so this won't all
                            connect together</li>
                        <li>The event has a few values we care about </li>
                    </aside>
                </section>
                <section>
<pre><code>&lt;?php

namespace App\Enrollment\Domain\Events;

use App\Enrollment\Domain\CourseOfferingId;
use App\Enrollment\Domain\StudentId;
use App\Support\Domain\Uuid;
use App\Support\EventHandling\Event;

class EnrollmentRequestRejected implements Event
{

    /**
     * @var Uuid
     */
    public $enrollmentRequestId;

    /**
     * @var StudentId
     */
    public $studentId;

    /**
     * @var CourseOfferingId
     */
    public $courseOfferingId;

    public function __construct(Uuid $enrollmentRequestId, StudentId $studentId, CourseOfferingId $courseOfferingId)
    {

        $this->enrollmentRequestId = $enrollmentRequestId;
        $this->studentId = $studentId;
        $this->courseOfferingId = $courseOfferingId;
    }

    /**
    * @return array
    */
    public function serialize()
    {
        return [
            'id' => $this->enrollmentRequestId->toString(),
            'student_id' => $this->studentId->toNative(),
            'course_offering_id' => $this->courseOfferingId->toNative(),
        ];
    }

    /**
    * @param array $data
    *
    * @return static
    */
    public static function deserialize($data)
    {
        return new StudentRequestedEnrollment(
            Uuid::fromString($data['id']),
            StudentId::fromNative($data['student_id']),
            CourseOfferingId::fromNative($data['course_offering_id'])
        );
    }
}
</code></pre>
                    <span class="fragment current-only" data-code-focus="10"></span>
                    <span class="fragment current-only" data-code-focus="28"></span>
                    <aside class="notes">
                        <li>(*) The Enrollment Request Rejected Event inherits from an Event class that outlines a bit of behavior.  </li>
                        <li>(*) The constructor sets the values we care about with the event object</li>
                        <li>And below we serialize and deserialize these attributes.  </li>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Domain Message Wrapper (Class)</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <p>Event can be wrapped by Domain message</p>
                            <p>This contains a version, timestamp, id, and the event itself</p>
                            <ul>
                                <li>stream id</li>
                                <li>version</li>
                                <li>payload (The Event)</li>
                                <li>recorded on</li>
                            </ul>
                        </article>
                    </myColBox>
                    <aside class="notes">
                        <li>In the first app we used Event Sourcing, scholarships, we included timestamp data on the
                            event, but for this application, my teammate had seen more consensus that the Event and
                            Message should be separated</li>
                        <li>We are able to keep the sequence and timestamp on the message, which holds the event as its payload</li>
                        <li>The version is useful ina  workflow project, where we want to upgrade these to use a new workflow.  We can keep track of which process was used to build something. </li>
                    </aside>
                </section>
                <section>
<pre><code>&lt;?php

namespace App\Support\Domain;

use App\Support\EventHandling\Event;
use DateTime;

class DomainMessage
{

    /**
     * @var string
     */
    private $streamId;

    /**
     * @var int
     */
    private $version;

    /**
     * @var Event
     */
    private $payload;

    /**
     * @var DateTime
     */
    private $recordedOn;

    /**
     * @param          $streamId
     * @param int      $version
     * @param Event    $payload
     * @param DateTime $recordedOn
     *
     * @internal param string $id
     */
    public function __construct($streamId, $version, Event $payload, DateTime $recordedOn)
    {
        $this->streamId = (string) $streamId;
        $this->version = $version;
        $this->payload = $payload;
        $this->recordedOn = $recordedOn;
    }

    /**
    * @param       $streamId
    * @param int   $version
    * @param Event $payload
    *
    * @return DomainMessage
    * @internal param string $id
    */
    public static function recordNow($streamId, $version, Event $payload)
    {
        return new DomainMessage($streamId, $version, $payload, new DateTime());
    }

    /**
    * {@inheritDoc}
    */
    public function getStreamId()
    {
        return $this->streamId;
    }

    /**
    * {@inheritDoc}
    */
    public function getVersion()
    {
        return $this->version;
    }

    /**
    * {@inheritDoc}
    */
    public function getPayload()
    {
        return $this->payload;
    }

    /**
    * {@inheritDoc}
    */
    public function getRecordedOn()
    {
        return $this->recordedOn;
    }

    /**
    * {@inheritDoc}
    */
    public function getType()
    {
        return get_class($this->payload);
    }
}

</code></pre>
                    <span class="fragment current-only" data-code-focus="39"></span>
                    <span class="fragment current-only" data-code-focus="55"></span>
                    <span class="fragment current-only" data-code-focus="63"></span>
                    <aside class="notes">
                        <li>This is our Domain Message class  </li>
                        <li>(*) The constructor sets the values for our stream id, version, payload, and timestamp</li>
                        <li>(*) We use the Record Now method to record that the event happened, returning the new Domain message</li>
                        <li>This at first seemed like extra work, but I've grown to like it a little more</li>
                        <li>Below we have getters to get attributes of the Domain Message </li>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Simple Event Listener </h2>
                    </myTitleBox>
<pre><code>&lt;?php

namespace App\Support\EventHandling;

use App\Support\Domain\DomainMessage;

abstract class SimpleEventListener implements EventListener
{
    /**
    * @param DomainMessage $message
    */
    public function handle(DomainMessage $message)
    {
        $event = $message->getPayload();
        $method = $this->getHandleMethod($event);

        if (! method_exists($this, $method)) {
            return;
        }

        $this->$method($event, $message);
    }

    private function getHandleMethod(Event $event)
    {
        return 'handle' . class_basename($event);
    }
}
</code></pre>
                    <span class="fragment current-only" data-code-focus="7"></span>
                    <span class="fragment current-only" data-code-focus="12"></span>
                    <span class="fragment current-only" data-code-focus="15"></span>
                    <span class="fragment current-only" data-code-focus="24"></span>
                    <aside class="notes">
                        <li>The Simple Event Listener Is one of our Support classes that does Event Handling</li>
                        <li>(*) there is a handle method that takes the Domain Message</li>
                        <li>It separates the Event from the message</li>
                        <li>(*) It calls a getHandle Method on the event.
                            (*) which uses the name of the event to construct its handle method</li>
                        <li>In addition to our Event classes, we have written methods that handle those events named
                            handleEventName, so this format allows us to handle the events in this way</li>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Event Store</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <p>A domain specific database </p>
                            <p>A functional database based on a publish-subscribe messages pattern</p>
                        </article>
                    </myColBox>
                    <aside class="notes">
                        <li>The Event Store, in our cases is a database table.  We aren't each event in its own table, so</li>
                        <li>We build the table to generically describe ALL of our events.</li>
                        <li>The classes that listen to those events subscribe only to the events that matter in that context</li>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Events Table - no Wrapper</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <img src="img/status_change/events_schol_struct.png">
                        </article>
                    </myColBox>
                    <aside class="notes">
                        The events in our Scholarships application did not use the Domain Message, so the timestamp was contained in the event itself.
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Events Table - no Wrapper</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <img src="img/status_change/events_schol_content.png">
                        </article>
                    </myColBox>
                    <aside class="notes">
                        We used the fully namespaced path of the Event to reference it as an aggregate type and we used an aggregate id
                        This is a direct contradiction to what we spoke about before with not storing an aggregate or an object as you
                    </aside>
                </section>
                <section>
<pre><code>
O:92:"ITECS\Scholarships\Selection\Domain\Scholarship\AwardWasAssignedToCandidateByCommitteeMember":9:{
    s:6:"amount"    ;O:39:    "ITECS\Scholarships\Common\Values\Amount":1:{
        s:46:"ITECS\Scholarships\Common\Values\Amountmoney"        ;
        O:11:        "Money\Money":2:{
            s:19:"Money\Moneyamount"            ;i:285000            ;s:21:"Money\Moneycurrency"            ;
            O:14:            "Money\Currency":1:{
                s:20:"Money\Currencyname"                ;s:3:"USD"                ;
            }
        }
    }    s:11:"applicantId"    ;
    s:9:"222222235"    ;
    s:13:"scholarshipId"    ;
    O:61:    "ITECS\Scholarships\Selection\Domain\Scholarship\ScholarshipId":1:{
        s:76:"ITECS\Scholarships\Selection\Domain\Scholarship\ScholarshipIdscholarshipId"        ;
        i:360        ;
    }    s:17:"selectionCriteria"    ;O:59:    "ITECS\Scholarships\Selection\Domain\Scholarship\CriteriaSet":1:{
    s:69:"ITECS\Scholarships\Selection\Domain\Scholarship\CriteriaSetcriteria"        ;a:1:{
        i:0            ;O:93:            "ITECS\Scholarships\Selection\Domain\Scholarship\SelectionCriteria\MemberOfDepartmentCriterion":4:{
            s:106:"ITECS\Scholarships\Selection\Domain\Scholarship\SelectionCriteria\MemberOfDepartmentCriteriondepartments"                ;a:1:{
                i:0                    ;O:43:                    "ITECS\Scholarships\Common\Values\Department":2:{
                s:50:"ITECS\Scholarships\Support\Types\CodedValuelabel"                        ;s:17:"Civil Engineering"                        ;s:49:"ITECS\Scholarships\Support\Types\CodedValuecode"                        ;s:2:"CE"                        ;
                }
            }                s:99:"ITECS\Scholarships\Selection\Domain\Scholarship\SelectionCriteria\SelectionCriterionisRequirement"                ;b:1                ;s:101:"ITECS\Scholarships\Selection\Domain\Scholarship\SelectionCriteria\SelectionCriterionotherProperties"                ;a:3:{
                s:4:"type"                    ;s:10:"department"                    ;s:5:"value"                    ;a:1:{
                    i:0                        ;s:2:"CE"                        ;
                }                    s:8:"priority"                    ;i:1                    ;
            }                s:14:"*description"                ;N;
        }
    }
}    s:17:"committeeMemberId"    ;s:8:"elstamey"    ;s:4:"term"    ;s:18:"Both Fall & Spring"    ;s:19:"snapshottedCriteria"    ;a:1:{
        i:0        ;a:3:{
            s:8:"required"            ;b:1            ;s:7:"matched"            ;b:1            ;s:11:"description"            ;s:69:"Must be a student within one of these departments: Civil Engineering."            ;
        }
    }    s:13:"applicantName"    ;s:13:"Alana  Feeney"    ;s:9:"occuredOn"    ;O:8:    "DateTime":3:{
        s:4:"date"        ;s:26:"2015-12-07 14:26:12.000000"        ;s:13:"timezone_type"        ;i:3        ;s:8:"timezone"        ;s:16:"America/New_York"        ;
    }
}
</code></pre>
                    <aside class="notes">
                        This is what the payload of the event looked like in that project, and it was really unwieldy to try to read from the events because it was a serialized object
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Events Table - with Domain Message</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <img src="img/status_change/events_eol_struct.png">
                        </article>
                    </myColBox>
                    <aside class="notes">
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Events Table - with Domain Message</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <img src="img/status_change/events_eol_content.png">
                        </article>
                    </myColBox>
                    <aside class="notes">
                    </aside>
                </section>
                <section>
<pre><code>
{
    "namespace":"App\\StudentInformation\\Entities\\Student",
    "identity":"ophelia.zieme",
    "data":{
        "id":"ophelia.zieme",
        "ferpa":"0",
        "personal":{
            "first_name":"Evan",
            "middle_name":"Jalon",
            "last_name":"Armstrong",
            "dob":"2007-06-16",
            "gender":"M"
        },
        "contact":{
            "student_id":"000811740",
            "username":"ophelia.zieme",
            "email":"ophelia.zieme@ncsu.edu",
            "phone":"935-516-1228"
        },
        "address":{
            "physical":{
                "street1":"707 Nasir Pass",
                "street2":"Jett Loop",
                "street3":null,
                "street4":"",
                "city":"Clemmons",
                "state":"NC",
                "zip":"27012",
                "country":"USA"
            },
            "permanent":{
                "street1":"759 Bashirian Plains",
                "street2":null,
                "street3":null,
                "street4":"",
                "city":"Clemmons",
                "state":"NC",
                "zip":"27012",
                "country":"USA"
            }
        },
        "citizenship":{
            "nc_resident":true,
            "country":"USA",
            "visa":null
        }
    }
}</code></pre>
                    <aside class="notes">
                        <li>We learned from that pain and stored the payload as a json object this time</li>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Event Store</h2>
                    </myTitleBox>
<pre><code>&lt;?php

namespace App\Support\EventStore;

use App\Support\Domain\DomainMessage;
use Illuminate\Database\Connection;
use Illuminate\Database\QueryException;
use Illuminate\Database\Schema\Blueprint;

class DatabaseEventStore implements EventStore
{
    /**
     * @var string
     */
    protected $tableClass;

    /**
     * @var Connection
     */
    private $connection;

    const MAX_EVENT_PAYLOAD_LENGTH = 65535;

    public function __construct($tableClass, Connection $connection)
    {
        $this->tableClass = $tableClass;
    $this->connection = $connection;
    }

    /**
    * @param $streamId
    *
    * @return DomainMessage[]
    */
    public function load($streamId)
    {
        $streamId = (string) $streamId;

        $rows = $this->connection->table($this->tableClass)
        ->where('stream_id', $streamId)
        ->orderBy('version', 'asc')
        ->get();

        if (! count($rows)) {
            throw EventStoreException::streamNotFound($streamId);
        }

        return $rows->map(function ($row) {
            return $this->deserializeEvent($row);
        })->all();
    }

    private function deserializeEvent($row)
    {
        $eventName = $row->type;
        $recordedOn = new \DateTime();
        $recordedOn->setTimestamp($row->recorded_on);

        return new DomainMessage(
            $row->stream_id,
            $row->version,
            $eventName::deserialize(json_decode($row->payload, true)),
            $recordedOn
        );
    }

    /**
    * @param                 $streamId
    * @param DomainMessage[] $messages
    */
    public function append($streamId, $messages)
    {
        $streamId = (string) $streamId;

        if (! is_array($messages)) {
            $messages = [$messages];
        }

        $this->connection->beginTransaction();

        try {

            foreach ($messages as $message) {
                $payloadData = $message->getPayload()->serialize();

                if (! is_array($payloadData)) {
                    throw EventStoreException::eventNotSerializable();
                }

                $encodedPayload = json_encode($payloadData);

                if (strlen($encodedPayload) >= self::MAX_EVENT_PAYLOAD_LENGTH) {
                    throw EventStoreException::encodedPayloadTooLarge($message->getType());
                }

                $this->connection->table($this->tableClass)->insert([
                        'stream_id' => $streamId,
                        'version' => $message->getVersion(),
                        'payload' => $encodedPayload,
                        'recorded_on' => $message->getRecordedOn()->getTimestamp(),
                        'type' => $message->getType(),
                    ]);
            }

                $this->connection->commit();

        } catch (QueryException $e) {
            $this->connection->rollBack();

            throw EventStoreException::optimisticLockingConflict($message->getStreamId(), $message->getVersion());
        }
    }

    public function configureSchema()
    {
        $schema = $this->connection->getSchemaBuilder();
        $schema->create($this->tableClass, function (Blueprint $table) {
            $table->increments('id');
            $table->string('stream_id', 255);
            $table->integer('version')->unsigned();
            $table->text('payload');
            $table->integer('recorded_on')->unsigned();
            $table->string('type');

            $table->index('stream_id');
            $table->index('type');
            $table->unique(['stream_id', 'version']);
        });
    }

    /**
    * @param $streamId
    *
    * @return int current version of the stream
    */
    public function version($streamId)
    {
        $streamId = (string) $streamId;

        $lastEvent = $this->connection->table($this->tableClass)
        ->where('stream_id', $streamId)
        ->orderBy('version', 'desc')
        ->first(['version']);

        if (! $lastEvent) {
            throw EventStoreException::streamNotFound($streamId);
        }

        return $lastEvent->version;
    }

    /**
    * @param Criteria $criteria
    * @param callable $handle
    *
    * @return DomainMessage[] $messages
    */
    public function visit(Criteria $criteria, callable $handle)
    {
        $this->connection->table($this->tableClass)->chunk(100, function ($events) use ($criteria, $handle) {

            foreach ($events as $event) {
                $message = $this->deserializeEvent($event);

                if ($criteria->isSatisfiedBy($message)) {
                    $handle($message);
                }
            }
        });
    }

    /**
    * @param string|null $streamId
    *
    * @return int the number of events in the store
    */
    public function count($streamId = null)
    {
        $events = $this->connection->table($this->tableClass);

        if ($streamId) {
            $events->where('stream_id', $streamId);
        }

        return $events->count();
    }
}
</code></pre>
                    <aside class="notes">
                        <p>code for the eventstore</p>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Listeners (Class)</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <ul>
                                <li>create listeners that listen to certain events and determine what they mean</li>
                                <li>StudentProfileProjector</li>
                                <li>EnrollmentRequests Read Model</li>
                            </ul>
                        </article>
                    </myColBox>
                    <aside class="notes">
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Projector </h2>
                    </myTitleBox>
<pre><code>&lt;?php

namespace App\Enrollment\ReadModel;


use App\Enrollment\Domain\Events\EnrollmentRequestRejected;
use App\Enrollment\Domain\Events\StudentRequestedEnrollment;
use App\Support\ReadModel\Replayable;
use App\Support\ReadModel\SimpleProjector;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Connection;

class EnrollmentRequestProjector extends SimpleProjector implements Replayable
{

    /**
     * @var Connection
     */
    private $connection;

    /**
     * @var string table we're playing events into
     */
    private $table = 'proj_enrollment_requests';

    public function __construct(Connection $connection)
    {
        $this->connection = $connection;
    }

    public function beforeReplay()
    {
        $builder = $this->connection->getSchemaBuilder();

        $builder->dropIfExists('proj_enrollment_requests_tmp');
        $builder->create('proj_enrollment_requests_tmp', function (Blueprint $schema) {
        $schema->string('id');
        $schema->string('student_id');
        $schema->string('course_offering_id');
        $schema->string('status');

        $schema->primary('id');
        });

        $this->table = 'proj_enrollment_requests_tmp';
    }

    public function afterReplay()
    {
        $builder = $this->connection->getSchemaBuilder();

        $builder->dropIfExists('proj_enrollment_requests');
        $builder->rename('proj_enrollment_requests_tmp', 'proj_enrollment_requests');

        $this->table = 'proj_enrollment_requests';
    }

    /**
    * @param StudentRequestedEnrollment $event
    */
    public function applyStudentRequestedEnrollment(StudentRequestedEnrollment $event)
    {
        $enrollmentRequest = new EnrollmentRequest();
        $enrollmentRequest->setTable($this->table);

        $enrollmentRequest->id = $event->enrollmentRequestId->toString();
        $enrollmentRequest->student_id = $event->studentId->toNative();
        $enrollmentRequest->course_offering_id = $event->courseOfferingId->toNative();
        $enrollmentRequest->status = 'requested';

        $enrollmentRequest->save();
    }

    /**
    * @param EnrollmentRequestRejected $event
    */
    public function applyEnrollmentRequestRejected(EnrollmentRequestRejected $event)
    {
        $enrollmentRequest = new EnrollmentRequest();
        $enrollmentRequest->setTable($this->table);

        $enrollmentRequest = EnrollmentRequest::where('id',  $event->enrollmentRequestId->toString());
        $enrollmentRequest->delete();
    }

}
</code></pre>
                    <span class="fragment current-only" data-code-focus="13"></span>
                    <span class="fragment current-only" data-code-focus="24"></span>
                    <span class="fragment current-only" data-code-focus="31"></span>
                    <span class="fragment current-only" data-code-focus="48"></span>
                    <span class="fragment current-only" data-code-focus="61"></span>
                    <span class="fragment current-only" data-code-focus="77"></span>
                    <aside class="notes">
                        <li>The Projector Builds a report based on the events; populates a table based on what those events mean to us</li>
                        <li>(*) This is our Enrollment Request Project, based on the Simple Projector</li>
                        <li>(*) It establishes a database connection,a nd we name the table</li>
                        <li>(*) BeforeReplay sets a temp table to replay events to, and as long as we don't have an error</li>
                        <li>(*) After Replay will move the temp table to a primary one</li>
                        <li>(*) This method applies a Student Requested Enrollment event; taking attributes from the event; We decided that for this projector, we want to add a row to the table when a new request comes in, and we set the status to "requested"</li>
                        <li>(*) Apply the Enrollment Request Rejected events</li>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Read Model </h2>
                    </myTitleBox>
<pre><code>&lt;?php

namespace App\Enrollment\ReadModel;


use Carbon\Carbon;
use Illuminate\Database\Eloquent\Model;

/**
* @codeCoverageIgnore
*/
class EnrollmentRequest extends Model
{
    protected  $table = 'proj_enrollment_requests';
    public $incrementing = false;
    public $timestamps = false;

    public static function current()
    {
        return static::where('student_id', auth()->user()->name)->get();
    }

    public static function lookupRequestsFor($username)
    {
        return static::where('student_id', $username)->get();
    }

    public function offering()
    {
        return $this->hasOne(CourseOffering::class, 'id', 'course_offering_id');
    }
}
</code></pre>
                    <span class="fragment current-only" data-code-focus="10"></span>
                    <aside class="notes">
                        <li>The Read Model looks at that projection, the source of truth, and allows us to request data from the projection</li>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                       <h2>Commands</h2>
                    </myTitleBox>
<pre><code>&lt;?php

namespace App\Enrollment\Commands;

use App\Support\CommandHandling\Command;
use App\Common\SemesterTerm;
use DateTime;
use Illuminate\Http\Request;

class ScheduleEnrollmentPeriod implements Command
{
    const DATE_FORMAT = DateTime::ATOM;

    /**
     * @var DateTime
     */
    public $open;

    /**
     * @var DateTime
     */
    public $close;

    /**
     * @var SemesterTerm
     */
    public $strm;

    public function __construct(DateTime $open, DateTime $close, SemesterTerm $strm)
    {
        $this->open = $open;
        $this->close = $close;
        $this->strm = $strm;
    }

    public static function fromRequest(Request $request)
    {
        return new static(
            static::parseDate($request->input('open'),'opened'),
            static::parseDate($request->input('close'),'closed'),
            SemesterTerm::fromNative($request->input('strm'))
        );
    }

    /**
    * The UI is presently sending a date 'Y-m-d' rather than a date-time, so attempt to parse as both if needed.
    *
    * @param $dateStr
    * @param $name
    * @return bool|DateTime
    */
    private static function parseDate($dateStr, $name)
    {
        // It should be noted that the time zone is presently set arbitrarily to EST all year around.
        // The standard HTML5 datetime-local (if we use it) will provide the local timezone selected.
        // The browser-supplied local timezone will possibly be different from the system timezone.
        // This will not be a problem right now, but may become confusing if open/close specify hours
        $dt = DateTime::createFromFormat(self::DATE_FORMAT, $dateStr."T00:00:00-05:00");

        if ($dt === FALSE) {
            $dt = DateTime::createFromFormat(self::DATE_FORMAT, $dateStr);
        }

        // This may be a bit defensive but createFromFormat does not throw exceptions
        // we don't expect bad dates to be passed in because it should be validated by the caller
        if ($dt === FALSE) {
            throw new \InvalidArgumentException(sprintf("%s date '%s' does not conform to the required format of '%s'",$name, $dateStr, self::DATE_FORMAT));
        }

        return $dt;
    }

    /**
    * @return array
    */
    public function serialize()
    {
        return [
            'open' => $this->open->format(self::DATE_FORMAT),
            'close' => $this->close->format(self::DATE_FORMAT),
            'strm' => $this->strm->toNative(),
        ];
    }

    /**
    * @param array $data
    *
    * @return static
    */
    public static function deserialize($data)
    {
        return new ScheduleEnrollmentPeriod(
            DateTime::createFromFormat(self::DATE_FORMAT, $data['open']),
            DateTime::createFromFormat(self::DATE_FORMAT, $data['close']),
            SemesterTerm::fromNative($data['strm'])
        );
    }
}
</code></pre>
                    <span class="fragment current-only" data-code-focus="10"></span>
                    <span class="fragment current-only" data-code-focus="36"></span>
                    <aside class="notes">
                        <p>This is our command</p>
                        <p>(*) It's called Schedule Enrollment Period</p>
                        <p>(*) We generally construct it from the Request object.  You can see the constructor above, and we are building it with attributes from the Request object we're getting from the form</p>
                        <li>These are the attributes we need when we are scheduling an enrollment period</li>
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                       <h2>Handler</h2>
                    </myTitleBox>
<pre><code>&lt;?php

namespace app\Enrollment\Commands;

use App\Enrollment\Domain\EnrollmentPeriod;
use App\Enrollment\IdentityProvider;
use App\Support\CommandHandling\CommandHandler;
use App\Support\Repository\EventSourcingRepository;
use Illuminate\Auth\Access\AuthorizationException;

class EnrollmentPeriodHandler extends CommandHandler
{
    /**
     * @var IdentityProvider
     */
    private $auth;

    /**
     * @var EventSourcingRepository
     */
    private $repository;

    public function __construct(IdentityProvider $auth, EventSourcingRepository $repository)
    {
        $this->auth = $auth;
        $this->repository = $repository;
    }

    /**
    * @param ScheduleEnrollmentPeriod $command
    * @throws AuthorizationException
    */
    public function handleScheduleEnrollmentPeriod(ScheduleEnrollmentPeriod $command)
    {
        $this->auth->getEOLCoordinatorId();

        $request = EnrollmentPeriod::schedule($command->open, $command->close, $command->strm);

        $this->repository->persist($request);
    }
}
</code></pre>
                    <span class="fragment current-only" data-code-focus="11"></span>
                    <span class="fragment current-only" data-code-focus="33"></span>
                    <span class="fragment current-only" data-code-focus="35-39"></span>
                    <span class="fragment current-only" data-code-focus="30,33"></span>
                    <aside class="notes">
                        <li>This is our command handler</li>
                        <li>(*) It's called the Enrollment Period Handler</li>
                        <li>(*) Inside we call our method to handle the Schedule Enrollment Command</li>
                        <li>(*) The body of this method actually schedules the enrollment period Based on attributes we pass with the command.  We pass the command as a parameter of this method above</li>
                        <li>(*) Right here</li>
                    </aside>
                </section>
                <section>
                    <myColBox>
                        <article>
                        </article>
                    </myColBox>
                    <aside class="notes">
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Pros</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <ul>
                                <li>maps closely to the process</li>
                                <li>flexible to changes in process</li>
                                <li>meaning of events can change without altering history</li>
                                <li>scholarships; able to back up all events to roll over a new year.<br>Didn&#39;t need to preserve full database.</li>
                            </ul>
                        </article>
                    </myColBox>
                    <aside class="notes">
                    </aside>
                </section>
                <section>
                    <myTitleBox>
                        <h2>Cons</h2>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <ul>
                                <li>a lot of classes</li>
                                <li>more design patterns to adjust to (complicated)</li>
                            </ul>
                        </article>
                    </myColBox>
                    <aside class="notes">
                    </aside>
                </section>
                <section>
                    <footer>
                        <img src="img/status_change/we-did-it.jpg">
                    </footer>
                </section>
                <section>
                    <myTitleBox>
                        <h3>Links for further reading</h3>
                    </myTitleBox>
                    <myColBox>
                        <article>
                            <ul>
                                <li><a href="https://www.youtube.com/watch?v=JHGkaShoyNs">Greg Young CQRS and Event Sourcing</a></li>
                                <li><a href="https://www.youtube.com/watch?v=whCk1Q87_ZI">Greg Young - long class</a></li>
                                <li><a href="https://www.youtube.com/watch?v=LDW0QWie21s">Greg Young - A Decade of DDD, CQRS, Event Sourcing</a></li>
                                <li><a href="https://www.phproundtable.com/episode/event-sourcing-in-php">PHP Round Table - Event Sourcing</a> (+2 more)</li>
                                <li><a href="https://github.com/broadway/broadway">Broadway - framework for CQRS and ES</a></li>
                            </ul>
                        </article>
                    </myColBox>
                    <aside class="notes">
                    </aside>
                </section>
                <section>
                    <img src="img/lonestarphp-logo.png">
                    <h1>Thank You!</h1>
                    <p>Emily Stamey</p>
                    <p>Twitter: <a href="https://twitter.com/elstamey">@elstamey</a></p>
                    <p>Joind.in: <a href="https://joind.in/talk/c8690">https://joind.in/talk/c8690</a></p>
                </section>
            </div>
        </div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				history: true,

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'node_modules/highlight.js/lib/highlight.js' },
					{ src: 'plugin/accessibility/helper.js', async: true, condition: function() {
						return !!document.body.classList;
					}},
					{
						src: 'node_modules/reveal-code-focus/reveal-code-focus.js',
						async: true,
						callback: function() {
							RevealCodeFocus();
						}
					},
					{ src: 'plugin/elapsed-time-bar/elapsed-time-bar.js'}
				],

                // The "normal" size of the presentation, aspect ratio will be preserved
                // when the presentation is scaled to fit different resolutions. Can be
                // specified using percentage units.
                width: 1280,
                height: 720,

                // Factor of the display size that should remain empty around the content
                margin: 0.1,

                // Bounds for smallest/largest possible scale to apply to content
                minScale: 0.2,
                maxScale: 1.5,


				// your allotted time for presentation
				allottedTime: 50 * 60 * 1000, // 50 minutes

				// - (optional) height of page/time progress bar
				progressBarHeight: 3,

				// - (optional) bar color
				barColor: 'rgb(200,0,0)',

				// - (optional) bar color when timer is paused
				pausedBarColor: 'rgba(200,0,0,.6)',

				// Display controls in the bottom right corner
				controls: true,

				// Display a presentation progress bar
				progress: true,

				// Display the page number of the current slide
				slideNumber: true,

				// Push each slide change to the browser history
				history: true,

				// Enable keyboard shortcuts for navigation
				keyboard: true,

				// Enable the slide overview mode
				overview: true,

				// Vertical centering of slides
				center: false,

				// Enables touch navigation on devices with touch input
				touch: true,

				// Loop the presentation
				loop: false,

				// Change the presentation direction to be RTL
				rtl: false,

				// Randomizes the order of slides each time the presentation loads
				shuffle: false,

				// Turns fragments on and off globally
				fragments: true,

				// Flags if the presentation is running in an embedded mode,
				// i.e. contained within a limited portion of the screen
				embedded: false,

				// Flags if we should show a help overlay when the questionmark
				// key is pressed
				help: true,

				// Flags if speaker notes should be visible to all viewers
				showNotes: false,

				// Number of milliseconds between automatically proceeding to the
				// next slide, disabled when set to 0, this value can be overwritten
				// by using a data-autoslide attribute on your slides
				autoSlide: 0,

				// Stop auto-sliding after user input
				autoSlideStoppable: true,

				// Use this method for navigation when auto-sliding
				autoSlideMethod: Reveal.navigateNext,

				// Enable slide navigation via mouse wheel
				mouseWheel: false,

				// Hides the address bar on mobile devices
				hideAddressBar: true,

				// Opens links in an iframe preview overlay
				previewLinks: false,

				// Transition style
				transition: 'none', // none/fade/slide/convex/concave/zoom

				// Transition speed
				transitionSpeed: 'default', // default/fast/slow

				// Transition style for full page slide backgrounds
				backgroundTransition: 'none', // none/fade/slide/convex/concave/zoom

				// Number of slides away from the current that are visible
				viewDistance: 3,

				// Parallax background image
				parallaxBackgroundImage: '', // e.g. "'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg'"

				// Parallax background size
				parallaxBackgroundSize: '', // CSS syntax, e.g. "2100px 900px"

				// Number of pixels to move the parallax background per slide
				// - Calculated automatically unless specified
				// - Set to 0 to disable movement along an axis
				parallaxBackgroundHorizontal: null,
				parallaxBackgroundVertical: null,

                // Value of the display CSS property applied to current slide to make it visible
                display: 'flex',

				keyboard: {
					// pause/resume time when Enter is pressed
					13: () => {
					ElapsedTimeBar.isPaused ? ElapsedTimeBar.resume() : ElapsedTimeBar.pause();
			},

			// reset timer when 'r' is pressed
			82: () => {
				ElapsedTimeBar.reset();
			}
			}
            })
        </script>
	</body>
</html>
